# CH552T 双模式控制器 - HID Joystick + MIDI Controller

**一个板子，两种模式！**  
通过上电时按键选择，在HID飞行控制器和MIDI控制器之间自由切换。

---

## 📋 目录

- [硬件连接](#硬件连接)
- [功能特性](#功能特性)
- [模式切换](#模式切换)
- [HID模式说明](#hid模式说明)
- [MIDI模式说明](#midi模式说明)
- [编译烧录](#编译烧录)
- [使用说明](#使用说明)
- [故障排查](#故障排查)

---

## 🔌 硬件连接

### 开发板信息
- **型号**: CH552T SuperMini USB 开发板
- **芯片**: CH552T (8051内核, USB HID支持)
- **时钟**: 16MHz 内部振荡器

### 引脚连接表（统一布局）

| 功能 | 引脚 | ADC通道 | HID模式功能 | MIDI模式功能 |
|------|------|---------|------------|-------------|
| **旋钮1/电位器1** | P1.4 | AIN1 | 油门轴 (Z轴) | CC13 (Effect Control 1) |
| **旋钮2/电位器2** | P1.1 | AIN0 | 反推轴 (Slider) | Pitch Bend (弯音轮) |
| **按钮1** | P3.1 | - | HID按钮1 / **模式选择** | MIDI音符C4 (60, 中央C) / **模式选择** |
| **按钮2** | P3.2 | - | HID按钮2 | MIDI音符A4 (69) |
| **按钮3** | P1.6 | - | HID按钮3 | 功能键(+12半音) |
| **按钮4** | P1.7 | - | HID按钮4 | 功能键(-12半音) |
| **LED指示灯** | P3.0 | - | 闪3次快速 | 闪5次慢速 |

**模式选择说明**：
- **按住按钮1上电** → MIDI模式（LED慢速闪5次）
- **不按任何按钮上电** → HID模式（LED快速闪3次）
- **按住按钮3+4上电** → ISP烧录模式（LED快速闪10次）

### 接线说明

**电位器/旋钮接线：**
```
旋钮引脚：
┌─────────┐
│  VCC    │ ← 5V或3.3V
│  信号   │ ← 接P1.1或P1.4
│  GND    │ ← GND
└─────────┘
```

**按钮接线：**
- 一端接对应引脚 (P3.1, P3.2, P1.6, P1.7)
- 另一端接GND
- 使用内部上拉，低电平有效

---

## ✨ 功能特性

### 双模式设计
- **HID模式**: USB Game Pad (游戏控制器)
  - 2个模拟轴（Z轴、Slider）
  - 4个按钮
  - 100Hz刷新率
  - 无需驱动，即插即用
  
- **MIDI模式**: USB MIDI Controller
  - CC13控制 (Effect Control 1)
  - Pitch Bend (弯音轮, -8192到8191)
  - 2个音符按键 (中央C4和A4) + 2个功能键
  - 功能键可移调±12半音（一个八度）
  - ADC校准映射，确保旋钮满行程

### 滤波系统
- **16次平均滤波**: 降低ADC噪声
- **50μs采样间隔**: 保证ADC稳定
- **响应延迟**: <5ms

### LED指示
- **HID模式**: 启动时快速闪3次
- **MIDI模式**: 启动时慢速闪5次
- **运行时**: 按下任何按钮时点亮

---

## 🔄 模式切换

### 切换方法（上电按键检测）

```
不按任何按钮 + 上电 → HID模式
┌────────────────────────────────┐
│ 1. 确保所有按钮都松开          │
│ 2. 插入USB线                   │
│ 3. LED快速闪3次 → HID模式生效  │
└────────────────────────────────┘

按住按钮1 + 上电 → MIDI模式
┌────────────────────────────────┐
│ 1. 按住按钮1(P3.1)             │
│ 2. 插入USB线                   │
│ 3. 等待LED慢速闪5次            │
│ 4. 松开按钮1 → MIDI模式生效    │
└────────────────────────────────┘

按住按钮3+4 + 上电 → ISP烧录模式
┌────────────────────────────────┐
│ 1. 同时按住按钮3(P1.6)+按钮4(P1.7)│
│ 2. 插入USB线                   │
│ 3. 等待LED快速闪10次           │
│ 4. 松开按钮 → 进入ISP模式      │
└────────────────────────────────┘
```

**注意**: 模式在上电时确定，运行中无法切换。如需更换模式，请拔掉USB重新上电。

---

## 🎮 HID模式说明

### 功能映射

| 硬件 | HID功能 | 用途示例 |
|------|---------|---------|
| 旋钮1 (P1.4) | Z轴 | Microsoft Flight Simulator - 油门 |
| 旋钮2 (P1.1) | Slider轴 | Microsoft Flight Simulator - 反推 |
| 按钮1 (P3.1) | Button 1 | AT Disengage (自动油门断开) |
| 按钮2 (P3.2) | Button 2 | TO/GA (起飞/复飞) |
| 按钮3 (P1.6) | Button 3 | 自定义功能 |
| 按钮4 (P1.7) | Button 4 | 自定义功能 |

### Windows配置

1. **打开控制面板**
   - 按 `Win+R`，输入 `joy.cpl`，回车

2. **校准轴**
   - 选择设备 → 属性 → 设置 → 校准
   - 分别校准 **Z轴** 和 **Slider轴**

3. **测试**
   - 测试标签页查看轴和按钮响应

---

## 🎹 MIDI模式说明

### 功能映射

| 硬件 | MIDI功能 | MIDI消息 | 说明 |
|------|---------|---------|------|
| 旋钮1 (P1.4) | CC13 | Control Change 13 | Effect Control 1 (范围0-127, 已校准满行程) |
| 旋钮2 (P1.1) | Pitch Bend | Pitch Bend | 弯音轮 (-8192到8191, 已校准满行程) |
| 按钮1 (P3.1) | 音符C4 | Note 60 | 单独按：C4 (中央C)<br>按钮3+按钮1：C5 (72)<br>按钮4+按钮1：C3 (48) |
| 按钮2 (P3.2) | 音符A4 | Note 69 | 单独按：A4<br>按钮3+按钮2：A5 (81)<br>按钮4+按钮2：A3 (57) |
| 按钮3 (P1.6) | 功能键 | - | 按住时：音符+12半音（高八度） |
| 按钮4 (P1.7) | 功能键 | - | 按住时：音符-12半音（低八度） |

### 功能键逻辑

```
按钮1单独按下 → 发送 Note C4 (60, 中央C)
按钮3+按钮1   → 发送 Note C5 (72) [+12半音]
按钮4+按钮1   → 发送 Note C3 (48) [-12半音]

按钮2单独按下 → 发送 Note A4 (69)
按钮3+按钮2   → 发送 Note A5 (81) [+12半音]
按钮4+按钮2   → 发送 Note A3 (57) [-12半音]
```

### ADC校准技术说明

由于电位器的物理特性，实际ADC读数范围通常无法达到理论上的0-255全范围。

**本项目的实测数据**：
- **实际ADC范围**: 0-172（而不是0-255）
- **ADC中心值**: 86
- **对应MIDI范围**: CC 0-86（未校准时）

**校准映射算法**：

```c
// CC13 映射（0-127满行程）
CC13 = adc_value * 127 / 172

// Pitch Bend 映射（-8192到+8191满行程）
Pitch Bend = (adc_value - 86) * 8192 / 86
```

**校准效果**：
- ✅ CC13完整行程：0 → 127
- ✅ Pitch Bend完整行程：-8192 → +8191
- ✅ Pitch Bend精确居中：ADC=86 → 0

**注意**：如果您使用不同规格的电位器，可能需要修改 `dual_mode_controller.c` 中的映射参数。

---

### DAW软件配置

#### Ableton Live
1. **Preferences** → **MIDI**
2. 在输入设备中启用 "Dual Mode Controller"
3. Track → In From → "Dual Mode Controller"

#### FL Studio
1. **Options** → **MIDI Settings**
2. 在Input中选择 "Dual Mode Controller"
3. 启用 "Enable"

#### Cubase
1. **Studio** → **Studio Setup** → **MIDI Port Setup**
2. 添加 "Dual Mode Controller"

---

## 🔨 编译烧录

### 编译环境要求
- **编译器**: SDCC (Small Device C Compiler) 4.x
- **工具**: packihx (SDCC自带)
- **系统**: Windows (CMD或PowerShell)

### 编译步骤

1. **安装SDCC**
   - 下载: https://sdcc.sourceforge.net/
   - 确保 `sdcc` 在PATH中

2. **编译**
   ```cmd
   cd MIDI_Joystick
   compile.bat
   ```

3. **编译输出**
   ```
   ===================================
   Dual Mode Controller Build Script
   ===================================
   
   [1/4] Cleaning old files...
   [2/4] Compiling source files...
   [3/4] Linking...
   [4/4] Converting to HEX format...
   
   ===================================
   Build successful!
   Output file: dual_mode_controller.hex
   ===================================
   ```

### 烧录步骤

#### 方法1: 软件进入ISP模式 ⭐ (推荐，无需拆盒子)

1. **同时按住按钮3和按钮4** (P1.6 + P1.7)
2. **保持按住，插入USB线**
3. **等待LED快速闪烁10次** (表示进入ISP模式)
4. **松开按钮**
5. 设备管理器应显示 "USB Module"

#### 方法2: 硬件按键进入ISP模式

1. **按住 P36 按钮** (板载按钮)
2. **插入USB线**
3. **松开 P36**
4. 设备管理器应显示 "USB Module"

#### 烧录固件

1. **使用WCH ISP Tool烧录**
   - 打开 WCH ISP Tool
   - 芯片: CH552
   - 文件: `dual_mode_controller.hex`
   - 点击"下载"

2. **验证**
   - 拔掉USB重新插入
   - 不按任何按钮：LED快速闪3次（HID模式）
   - 按住按钮1：LED慢速闪5次（MIDI模式）
   - 按住按钮3+4：LED快速闪10次（ISP模式）

---

## 📖 使用说明

### HID模式使用

1. **不按任何按钮上电** → 进入HID模式
2. LED快速闪3次确认
3. Windows自动识别为游戏控制器
4. 打开 `joy.cpl` 校准和测试
5. 在游戏/模拟器中配置轴和按钮

### MIDI模式使用

1. **按住按钮1上电** → 进入MIDI模式
2. LED慢速闪5次确认
3. Windows识别为MIDI设备
4. **方法A: 使用测试工具 (推荐)** ⭐
   ```bash
   # 安装依赖
   pip install -r requirements.txt
   
   # 启动测试工具
   python midi_tester.py
   ```
   - 自动识别设备
   - 实时显示CC13和Pitch Bend
   - 显示音符按键
   - 播放Beep音
   - 详细的MIDI日志
   
   **详细说明请查看**: `MIDI_TESTER_README.md`

5. **方法B: 使用DAW软件**
   - 打开DAW软件（如Ableton Live）
   - 在MIDI设置中启用设备
   - 使用旋钮控制CC和Pitch Bend
   - 使用按钮演奏音符

---

## 🔧 故障排查

### 模式切换问题

| 问题 | 原因 | 解决方法 |
|------|------|---------|
| LED不闪烁 | 固件未烧录 | 检查烧录是否成功 |
| 模式无法切换 | 按钮1接线错误 | 检查P3.1连接，确保上拉 |
| LED闪烁次数不对 | 按键状态检测错误 | 重新上电，确保按键时机正确 |

### HID模式问题

| 问题 | 原因 | 解决方法 |
|------|------|---------|
| 轴不响应 | ADC引脚未连接 | 检查P1.1和P1.4接线 |
| 按钮不工作 | 引脚错误 | 检查P3.1, P3.2, P1.6, P1.7 |
| 设备未识别 | 驱动问题 | 重新插拔USB |

### MIDI模式问题

| 问题 | 原因 | 解决方法 |
|------|------|---------|
| DAW无响应 | 设备未启用 | 在DAW的MIDI设置中启用 |
| 音符不发声 | 力度为0 | 检查代码中MIDI_VELOCITY设置 |
| CC值不变化 | 阈值过大 | 调整ADC阈值 |

---

## 🚀 技术细节

### 代码结构

```
MIDI_Joystick/
├── dual_mode_controller.c   # 主程序（双模式逻辑）
├── compile.bat               # 编译脚本
├── src/
│   ├── config.h              # 配置文件（引脚、模式定义）
│   ├── usb_descr.c           # USB描述符（4按钮HID）
│   ├── usb_composite_simple.c # HID函数
│   ├── usb_hid.c             # HID底层
│   ├── usb_handler.c         # USB事件处理
│   ├── delay.c               # 延时函数
│   ├── ch554.h               # 芯片寄存器定义
│   ├── gpio.h                # GPIO宏
│   └── system.h              # 系统函数
└── README.md                 # 本文档
```

### 主要功能模块

```c
// 模式检测
uint8_t detect_mode(void)      // 上电时检测P3.4状态

// LED指示
void indicate_mode(uint8_t mode) // 根据模式闪烁LED

// HID模式主循环
void run_hid_mode(void)        // 2旋钮+4按钮 → USB HID

// MIDI模式主循环
void run_midi_mode(void)       // CC13+PitchBend+音符+功能键 → USB MIDI
```

---

## 📝 版本历史

### v1.0 (2025-11-18)
- ✅ 初始版本
- ✅ **双模式支持**：HID游戏控制器 + USB MIDI控制器
- ✅ **HID模式**：2旋钮（Z轴/Slider）+ 4按钮
- ✅ **MIDI模式**：
  - CC13 (Effect Control 1) - 完整行程 0-127
  - Pitch Bend (弯音轮) - 完整行程 -8192到+8191
  - 2个音符按键（C4/A4，中央C组）
  - 2个功能键（八度移调±12半音）
  - ADC校准算法，解决电位器行程不满问题
- ✅ **模式切换**：
  - 按钮1上电 → MIDI模式
  - 不按按钮上电 → HID模式
  - 按钮3+4上电 → ISP烧录模式
- ✅ **性能优化**：
  - 16次平均滤波降噪
  - 100Hz刷新率
  - <5ms响应延迟
- ✅ **开发工具**：Python MIDI测试工具
- ✅ **跨平台支持**：Windows/macOS/Linux

---

## 👥 贡献者

- **硬件设计**: DIY
- **固件开发**: 基于FlightController_HID项目扩展
- **测试验证**: Windows 11 + MSFS 2024 / Ableton Live

---

## 📄 许可证

本项目基于 MacroPad Plus 项目，遵循其原始许可证。

---

**项目完成日期**: 2025-11-18  
**开发板**: CH552T SuperMini USB  
**支持平台**: Windows 10/11

---

*Happy Making! 🎉*

