# 🔄 模式选择更新说明

## 重要变更

由于实际硬件上没有连接P3.4的按钮，模式选择方式已更改为使用**按钮1(P3.1)**。

---

## 新的模式选择方式

### 🎮 HID模式
```
不按任何按钮 + 上电
↓
LED快速闪3次
↓
HID飞行控制器模式
```

### 🎹 MIDI模式
```
按住按钮1(P3.1) + 上电
↓
LED慢速闪5次
↓
MIDI控制器模式
```

### 💾 ISP烧录模式
```
按住按钮3(P1.6) + 按钮4(P1.7) + 上电
↓
LED快速闪10次
↓
ISP烧录模式
```

---

## 按钮功能说明

### 按钮1 (P3.1) - 多功能按钮

**上电时（模式选择阶段）：**
- **按住** → 进入MIDI模式
- **松开** → 进入HID模式

**进入系统后：**
- **HID模式** → 作为按钮1使用
- **MIDI模式** → 发送音符C1(36)

---

## 更新的引脚表

| 引脚 | 上电功能 | HID模式运行时 | MIDI模式运行时 |
|------|---------|--------------|---------------|
| **P3.1** | **模式选择** | 按钮1 | 音符C1 |
| P3.2 | - | 按钮2 | 音符A1 |
| P1.6 | ISP检测 | 按钮3 | 功能键+12 |
| P1.7 | ISP检测 | 按钮4 | 功能键-12 |
| P3.0 | LED指示 | LED指示 | LED指示 |

---

## 代码修改

### 修改的文件
1. ✅ `dual_mode_controller.c` - detect_mode()函数
2. ✅ `src/config.h` - 引脚定义注释
3. ✅ `README.md` - 使用说明
4. ✅ `compile.bat` - 提示信息
5. ✅ `QUICK_REFERENCE.md` - 快速参考

### 关键代码
```c
// 检测工作模式（上电时调用）
uint8_t detect_mode(void) {
  // 注意：按钮引脚已在main中配置为输入上拉
  DLY_ms(10);  // 等待稳定
  
  // 检测按钮1(P3.1)状态
  // 按钮按下=低电平=MIDI模式
  if(P3 & (1<<1)) {
    return MODE_HID;   // 按钮1松开 = HID飞行控制器模式
  } else {
    return MODE_MIDI;  // 按钮1按下 = MIDI控制器模式
  }
}
```

---

## LED指示总结

| LED模式 | 含义 | 触发条件 |
|---------|------|---------|
| 快速闪3次 | HID模式 | 不按任何按钮上电 |
| 慢速闪5次 | MIDI模式 | 按住按钮1上电 |
| 快速闪10次 | ISP模式 | 按住按钮3+4上电 |

---

## 优点

✅ 使用现有硬件，无需额外接线  
✅ 按钮1复用，充分利用资源  
✅ 逻辑清晰，易于理解  
✅ 与ISP模式不冲突（不同按钮组合）  

---

## 注意事项

1. **按钮1在上电时有双重功能**
   - 上电检测阶段：模式选择
   - 进入系统后：普通按钮功能

2. **模式确定时机**
   - 模式在上电后约10ms内确定
   - LED闪烁后模式已锁定
   - 运行中无法切换，需重新上电

3. **按钮1在MIDI模式下的使用**
   - 正常发送音符C1
   - 配合功能键可移调
   - 与其他按钮功能一致

---

## 测试步骤

### 1. 测试HID模式
```
1. 确保所有按钮松开
2. 插入USB
3. 观察LED快速闪3次
4. 打开joy.cpl测试4个按钮
```

### 2. 测试MIDI模式
```
1. 按住按钮1(P3.1)
2. 插入USB
3. 观察LED慢速闪5次
4. 松开按钮1
5. 打开midi_tester.py
6. 测试按钮1发送音符C1
```

### 3. 测试ISP模式
```
1. 同时按住按钮3+4
2. 插入USB
3. 观察LED快速闪10次
4. 松开按钮
5. WCH ISP Tool识别设备
```

---

## 常见问题

**Q: 为什么不用按钮2、3或4作为模式选择？**  
A: 按钮1在代码中最先被配置，逻辑最简单。按钮3+4已用于ISP模式。

**Q: 按钮1会不会和MIDI的C1音符冲突？**  
A: 不会。模式检测只在上电时进行，进入系统后按钮1恢复正常功能。

**Q: 能否改回使用P3.4？**  
A: 可以。只需修改detect_mode()函数，检测P3.4而非P3.1，并添加P3.4的GPIO初始化代码。

**Q: 按钮1在HID模式下正常吗？**  
A: 完全正常。模式确定后，按钮1就是普通的HID按钮1，与其他按钮无异。

---

**更新日期**: 2025-11-18  
**版本**: v1.2  
**状态**: ✅ 已更新并测试

