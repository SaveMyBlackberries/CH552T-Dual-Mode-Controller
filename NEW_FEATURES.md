# 🎉 新增功能说明

## 功能1: 软件进入ISP烧录模式 ⭐

### 问题
装入盒子后，每次烧录固件都需要按住板载的P36按钮，很不方便，需要拆盒子。

### 解决方案
**同时按住按钮3和按钮4上电，自动进入ISP烧录模式！**

### 使用方法

```
1. 同时按住按钮3(P1.6) + 按钮4(P1.7)
2. 保持按住，插入USB线
3. 观察LED快速闪烁10次（表示进入ISP模式）
4. 松开按钮
5. 打开WCH ISP Tool烧录
```

### LED指示说明

| LED闪烁模式 | 含义 |
|------------|------|
| 快速闪3次 | HID模式启动 |
| 慢速闪5次 | MIDI模式启动 |
| **快速闪10次** | **进入ISP烧录模式** ⭐ |

### 代码实现

在`dual_mode_controller.c`的`main()`函数中添加：

```c
// 检测是否进入ISP烧录模式
DLY_ms(10);  // 等待按钮稳定
if(!(P1 & (1<<6)) && !(P1 & (1<<7))) {
    // 两个按钮都按下，进入ISP模式
    // LED快速闪烁10次提示
    for(uint8_t i = 0; i < 10; i++) {
        P3 |= (1<<0);
        DLY_ms(50);
        P3 &= ~(1<<0);
        DLY_ms(50);
    }
    // 跳转到Bootloader
    BOOT_now();
}
```

### 优点

✅ 无需拆盒子  
✅ 无需找P36按钮  
✅ 任何时候都能进入ISP模式  
✅ LED有明确提示  
✅ 不影响正常使用  

---

## 功能2: MIDI测试工具 🎹

### 问题
需要一个简单的工具来测试MIDI功能是否正常，验证CC、Pitch Bend和音符。

### 解决方案
**Python编写的图形化MIDI测试工具！**

### 功能特性

#### 1. 实时CC1显示
- 绿色进度条
- 数值显示(0-127)
- 实时更新

#### 2. 实时Pitch Bend显示
- 蓝色双向进度条
- 中心为0
- 数值显示(-8192到8191)

#### 3. 音符可视化
- 6个音符按钮
- 按下时高亮显示
- 自动播放对应频率Beep音

#### 4. MIDI消息日志
- 时间戳
- 完整的MIDI消息
- 自动滚动

### 安装和使用

```bash
# 1. 安装依赖
cd MIDI_Joystick
pip install -r requirements.txt

# 2. 启动测试工具
python midi_tester.py

# 3. 选择设备
在下拉框中选择"Dual Mode Controller"

# 4. 开始测试！
```

### 界面预览

```
┌───────────────────────────────────────────┐
│        🎹 MIDI控制器测试工具               │
├───────────────────────────────────────────┤
│  MIDI设备: [Dual Mode Controller] [刷新] │
├──────────────────┬────────────────────────┤
│                  │                        │
│  CC1 (调制轮)     │    音符显示区          │
│  ╔═══════════╗   │   ┌────────────┐      │
│  ║████████░░░║   │   │  C0 (24)  │       │
│  ╚═══════════╝   │   ├────────────┤      │
│      85          │   │  A0 (21)  │       │
│                  │   ├────────────┤      │
│ Pitch Bend      │   │  C1 (36)  │ ←高亮  │
│  ╔═══════════╗   │   ├────────────┤      │
│  ║░░░█████░░░║   │   │  A1 (33)  │       │
│  ╚═══════════╝   │   ├────────────┤      │
│     -1024        │   │  C2 (48)  │       │
│                  │   ├────────────┤      │
│                  │   │  A2 (45)  │       │
│                  │   └────────────┘      │
├──────────────────┴────────────────────────┤
│  MIDI消息日志                             │
│  [12:34:56.789] ✓ 已连接到设备            │
│  [12:34:57.123] CC1: 85                  │
│  [12:34:57.456] Pitch Bend: -1024        │
│  [12:34:58.012] ♪ Note On: C1 (36)      │
│  [12:34:58.234] ♪ Note Off: C1 (36)     │
└───────────────────────────────────────────┘
```

### 测试项目

使用测试工具验证：

**CC1测试**：
- [ ] 转动旋钮1，数值0-127变化
- [ ] 进度条同步更新
- [ ] 日志显示CC1消息

**Pitch Bend测试**：
- [ ] 转动旋钮2，数值-8192到8191变化
- [ ] 双向进度条正确显示
- [ ] 日志显示Pitch Bend消息

**音符测试**：
- [ ] 按钮1 → C1 (36)，按钮高亮，播放131Hz
- [ ] 按钮2 → A1 (33)，按钮高亮，播放110Hz
- [ ] 按钮3+按钮1 → C2 (48)，高八度
- [ ] 按钮4+按钮1 → C0 (24)，低八度
- [ ] 功能键切换时正确切换音符

### 技术实现

**使用的库**：
- `tkinter` - GUI界面（Python标准库）
- `pygame.midi` - MIDI通信
- `winsound` - 播放Beep音（Windows标准库）

**主要功能**：
- 多线程MIDI消息接收
- 实时UI更新
- Canvas绘制进度条
- 音符频率映射

### 文件说明

- `midi_tester.py` - 主程序（约350行）
- `requirements.txt` - Python依赖
- `MIDI_TESTER_README.md` - 详细使用说明

---

## 📦 更新的文件列表

### 新增文件
1. `midi_tester.py` - MIDI测试工具
2. `requirements.txt` - Python依赖
3. `MIDI_TESTER_README.md` - 测试工具说明
4. `NEW_FEATURES.md` - 本文档

### 修改的文件
1. `dual_mode_controller.c` - 添加ISP模式检测
2. `README.md` - 更新烧录和测试说明

---

## 🎯 快速开始

### 1. 编译新固件

```bash
cd MIDI_Joystick
compile.bat
```

### 2. 烧录固件（使用新方法）

```
1. 同时按住按钮3+按钮4
2. 插入USB线
3. LED快速闪10次
4. 松开按钮
5. 使用WCH ISP Tool烧录 dual_mode_controller.hex
```

### 3. 测试MIDI功能

```bash
# 安装测试工具
pip install -r requirements.txt

# 按住P3.4上电（MIDI模式）
# LED慢速闪5次

# 启动测试工具
python midi_tester.py
```

---

## 💡 使用技巧

### ISP模式技巧

1. **确认进入ISP模式**：LED必须闪10次
2. **如果没反应**：检查按钮3和按钮4是否都按下
3. **退出ISP模式**：重新上电即可

### MIDI测试技巧

1. **设备识别**：确保MIDI模式启动（LED闪5次）
2. **多次刷新**：如果找不到设备，点击"刷新"按钮
3. **观察日志**：所有MIDI消息都会显示在日志区
4. **音符测试**：先测试单个按钮，再测试功能键组合

---

## 🔍 故障排查

### ISP模式问题

**问题：LED不闪10次**
- 确认同时按住两个按钮
- 检查按钮接线（P1.6, P1.7）
- 尝试按住后再插USB

**问题：进入ISP后无法烧录**
- 检查WCH驱动是否安装
- 确认设备管理器显示"USB Module"
- 重新插拔USB

### 测试工具问题

**问题：找不到MIDI设备**
- 确认MIDI模式启动（LED闪5次）
- 点击"刷新"按钮
- 检查Windows设备管理器

**问题：pygame安装失败**
```bash
python -m pip install --upgrade pip
pip install pygame
```

**问题：无法播放Beep音**
- 正常现象，不是所有系统都支持
- 不影响MIDI测试功能
- 可以通过按钮高亮和日志确认

---

## 🎉 总结

这两个新功能极大地提升了使用体验：

✅ **软件ISP模式** - 再也不用拆盒子了！  
✅ **MIDI测试工具** - 快速验证所有MIDI功能！  

享受你的双模式控制器吧！🎮🎹

---

**更新日期**: 2025-11-18  
**版本**: v1.1  
**状态**: ✅ 已测试并可用

