# MIDI测试工具使用说明

## 🎹 功能说明

这是一个专为双模式控制器设计的MIDI测试软件，用于验证MIDI功能是否正常工作。

### 主要功能

1. **CC13显示** - 实时显示Effect Control 1(CC13)的值(0-127)，带进度条，✅ 已校准满行程
2. **Pitch Bend显示** - 实时显示弯音轮的值(-8192到8191)，带双向进度条，✅ 已校准满行程
3. **音符显示** - 显示当前按下的音符（C4/A4组），按钮会高亮
4. **音符播放** - 按下音符时会播放对应频率的Beep音
5. **MIDI日志** - 实时显示所有MIDI消息

---

## 📦 安装依赖

### 方法1: 使用pip安装

```bash
cd MIDI_Joystick
pip install -r requirements.txt
```

### 方法2: 手动安装

```bash
pip install pygame
```

---

## 🚀 启动测试软件

```bash
python midi_tester.py
```

---

## 📖 使用说明

### 1. 连接设备

1. 将CH552T控制器**按住按钮1(P3.1)**上电，进入MIDI模式
2. 确认LED慢速闪5次（MIDI模式指示）
3. 等待Windows识别MIDI设备

### 2. 启动测试软件

1. 运行 `python midi_tester.py`
2. 在设备下拉框中选择"Dual Mode Controller"
3. 点击"刷新"按钮如果没有看到设备
4. 连接成功后，日志区会显示"✓ 已连接到设备"

### 3. 测试各项功能

#### 测试CC13（旋钮1）
- 转动P1.4上的旋钮
- 观察CC13进度条和数值变化
- 范围：0-127（✅ 已校准满行程）
- 日志显示：`CC13: XX`

#### 测试Pitch Bend（旋钮2）
- 转动P1.1上的旋钮
- 观察Pitch Bend双向进度条
- 中间为0，左负右正
- 范围：-8192到8191（✅ 已校准满行程）
- 日志显示：`Pitch Bend: XXXX`

#### 测试音符按键

**按钮1 (P3.1) - 音符C（中央C）**
- 单独按：C4 (60) - 按钮高亮，播放262Hz音（中央C）
- 按住按钮3：C5 (72) - 高八度
- 按住按钮4：C3 (48) - 低八度

**按钮2 (P3.2) - 音符A**
- 单独按：A4 (69) - 按钮高亮，播放440Hz音（标准音高A）
- 按住按钮3：A5 (81) - 高八度
- 按住按钮4：A3 (57) - 低八度

**按钮3 (P1.6) - 功能键**
- 按住不放，然后按按钮1或2
- 音符升高12半音（一个八度）

**按钮4 (P1.7) - 功能键**
- 按住不放，然后按按钮1或2
- 音符降低12半音（一个八度）

---

## 🎨 界面说明

```
┌─────────────────────────────────────────┐
│      🎹 MIDI控制器测试工具               │
├─────────────────────────────────────────┤
│  MIDI设备: [选择设备] [刷新]            │
├──────────────────┬──────────────────────┤
│                  │                      │
│  CC13 (Effect Control 1) │ 音符显示区      │
│  ╔═══════════╗   │   ┌──────────┐      │
│  ║████████░░░║   │   │ C0 (24) │       │
│  ╚═══════════╝   │   ├──────────┤      │
│      85          │   │ A0 (21) │       │
│                  │   ├──────────┤      │
│ Pitch Bend      │   │ C1 (36) │ ←高亮  │
│  ╔═══════════╗   │   ├──────────┤      │
│  ║░░░█████░░░║   │   │ A1 (33) │       │
│  ╚═══════════╝   │   ├──────────┤      │
│     -1024        │   │ C2 (48) │       │
│                  │   ├──────────┤      │
│                  │   │ A2 (45) │       │
│                  │   └──────────┘      │
├──────────────────┴──────────────────────┤
│  MIDI消息日志                           │
│  [12:34:56.789] ✓ 已连接到设备          │
│  [12:34:57.123] CC1: 85                │
│  [12:34:57.456] Pitch Bend: -1024      │
│  [12:34:58.012] ♪ Note On: C1 (36)    │
│  [12:34:58.234] ♪ Note Off: C1 (36)   │
└─────────────────────────────────────────┘
```

---

## 🔍 故障排查

### 问题1: 找不到MIDI设备

**解决方法**：
1. 确认控制器按住P3.4上电（MIDI模式）
2. 检查设备管理器中是否显示MIDI设备
3. 点击"刷新"按钮
4. 重新插拔USB

### 问题2: pygame安装失败

**解决方法**：
```bash
# 使用pip升级
python -m pip install --upgrade pip
pip install pygame

# 或者下载wheel文件安装
# 访问: https://www.lfd.uci.edu/~gohlke/pythonlibs/#pygame
```

### 问题3: 无法播放音符

**原因**: Windows Beep功能可能被禁用或不支持

**解决方法**：
- 音符播放是额外功能，不影响MIDI测试
- 可以通过日志和按钮高亮确认音符消息
- 或者在DAW中测试（如Ableton Live）

### 问题4: CC/Pitch Bend值跳动

**原因**: 电位器噪声或连接不良

**解决方法**：
- 检查电位器接线
- 固件已有16次平均滤波
- 轻微跳动(±1-2)是正常的

---

## 📊 测试检查清单

使用此清单验证MIDI功能：

### 基础连接测试
- [ ] 软件能识别到MIDI设备
- [ ] 连接后日志显示成功消息

### CC13测试
- [ ] 转动旋钮1，CC13值能从0变化到127（✅ 满行程）
- [ ] 进度条正确反映CC13值
- [ ] 日志显示CC13消息

### Pitch Bend测试
- [ ] 转动旋钮2，Pitch Bend值能从-8192变化到8191（✅ 满行程）
- [ ] 中间位置为0（✅ 精确居中）
- [ ] 双向进度条正确显示
- [ ] 日志显示Pitch Bend消息

### 音符测试（基础）
- [ ] 按钮1发送C4 (60, 中央C)
- [ ] 按钮2发送A4 (69, 标准音高A)
- [ ] 按钮高亮显示正确
- [ ] Note On/Off消息正确
- [ ] 播放对应频率音（C4=262Hz, A4=440Hz）

### 音符测试（功能键）
- [ ] 按钮3+按钮1发送C5 (72, +12半音)
- [ ] 按钮3+按钮2发送A5 (81, +12半音)
- [ ] 按钮4+按钮1发送C3 (48, -12半音)
- [ ] 按钮4+按钮2发送A3 (57, -12半音)
- [ ] 功能键切换时正确发送Note Off

---

## 💡 高级用法

### 在DAW中测试

如果想要更专业的测试：

1. **Ableton Live**
   - Preferences → MIDI → 启用设备
   - 创建MIDI轨道
   - 录制MIDI并查看

2. **MIDI Monitor工具**
   - 下载MIDI-OX (Windows)
   - 查看原始MIDI字节
   - 验证消息格式

3. **Virtual MIDI Cable**
   - 使用loopMIDI创建虚拟MIDI端口
   - 测试MIDI路由

---

## 🎵 音符频率表

测试软件播放的音符频率：

| 音符 | MIDI值 | 频率(Hz) | 说明 |
|------|--------|---------|------|
| A0   | 21     | 55      | 最低音A |
| C0   | 24     | 65      | 低八度C |
| A1   | 33     | 110     | 默认A |
| C1   | 36     | 131     | 默认C |
| A2   | 45     | 220     | 高八度A |
| C2   | 48     | 262     | 高八度C (中央C) |

---

## 🐛 已知限制

1. **Beep播放**：Windows系统Beep功能可能不支持所有频率
2. **延迟**：Python GUI有一定延迟，专业测试建议用MIDI Monitor
3. **跨平台**：目前仅测试Windows，Mac/Linux可能需要调整

---

## 📝 开发说明

### 修改音符映射

编辑 `midi_tester.py` 中的音符定义：

```python
self.note_names = {
    21: "A0", 24: "C0", 33: "A1", 36: "C1",
    45: "A2", 48: "C2"
    # 添加更多音符
}

self.note_freqs = {
    21: 55, 24: 65, 33: 110, 36: 131,
    45: 220, 48: 262
    # 添加更多频率
}
```

### 修改UI主题

在 `setup_ui()` 方法中修改颜色：

```python
bg='#2b2b2b'    # 背景色
fg='white'       # 前景色
fill='#4CAF50'   # CC1进度条颜色
fill='#2196F3'   # Pitch Bend进度条颜色
```

---

**祝测试顺利！** 🎉

如有问题，请查看主README.md或检查MIDI连接。

